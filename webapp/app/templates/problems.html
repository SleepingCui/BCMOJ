<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>题目列表</title>
<link rel="stylesheet" href="/static/css/bootstrap.min.css">
<link rel="stylesheet" href="/static/css/bootstrap-icons.css">
<link rel="stylesheet" href="/static/css/problems.css">
</head>
<body>
<div class="toast-container"></div>

<div class="header-container">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <h1 class="h3 mb-0 animate-fade-in"><i class="bi bi-list-task me-2"></i>题目列表</h1>

            <form class="search-box d-flex animate-fade-in" method="get">
                <input type="text" name="q" class="form-control border-0 shadow-none" placeholder="搜索题目..." value="{{ query|default('') }}" id="searchInput">
                <button type="submit" class="btn"><i class="bi bi-search"></i></button>
            </form>

            <div class="d-flex align-items-center">
                <div class="user-info-card animate-fade-in" id="userInfo">
                    <i class="bi bi-person-circle"></i>
                    <span>未登录</span>
                </div>
                <button class="btn btn-light user-action-btn animate-fade-in" id="loginBtn">登录</button>
                <button class="btn btn-outline-light user-action-btn animate-fade-in d-none" id="logoutBtn">登出</button>
                <button class="btn btn-outline-light user-action-btn animate-fade-in d-none" id="editAccountBtn">修改账户信息</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="problem-list">
        {% if problems %}
            {% for p in problems %}
            <a href="{{ url_for('problem', problem_id=p['problem_id']) }}" class="problem-card card problem-item" style="--item-index: {{ loop.index }};">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <span class="problem-title h5">{{ p['title'] or '（无标题）' }}</span>
                        <p class="text-muted mb-0 mt-1">
                            <small>题目ID: <span class="problem-id">{{ p['problem_id'] }}</span></small>
                        </p>
                    </div>
                    <div>
                        <i class="bi bi-chevron-right text-muted"></i>
                    </div>
                </div>
            </a>
            {% endfor %}
        {% else %}
            <div class="text-center py-5 animate-fade-in">
                <i class="bi bi-inbox display-4 text-muted"></i>
                <p class="mt-3 text-muted">没有找到题目!</p>
            </div>
        {% endif %}
    </div>

    <div class="pagination-container mt-4 animate-fade-in">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div class="d-flex align-items-center">
                <span class="text-muted">共 {{ total_pages }} 页</span>
            </div>
            
            <ul class="pagination pagination-new mb-0">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('problems', q=query, page=page-1) }}"><i class="bi bi-chevron-left"></i></a>
                </li>
                {% endif %}
                {% set start_page = [1, page-2] | max %}
                {% set end_page = [total_pages, page+2] | min %}
                {% if start_page > 1 %}
                <li class="page-item"><a class="page-link" href="{{ url_for('problems', q=query, page=1) }}">1</a></li>
                {% if start_page > 2 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                {% endif %}
                {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="{{ url_for('problems', q=query, page=p) }}">{{ p }}</a></li>
                {% endfor %}
                {% if end_page < total_pages %}
                {% if end_page < total_pages - 1 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
                <li class="page-item"><a class="page-link" href="{{ url_for('problems', q=query, page=total_pages) }}">{{ total_pages }}</a></li>
                {% endif %}
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('problems', q=query, page=page+1) }}"><i class="bi bi-chevron-right"></i></a>
                </li>
                {% endif %}
            </ul>

            <div class="jump-container">
                <input type="number" id="jumpPage" class="form-control" min="1" max="{{ total_pages }}" placeholder="页码">
                <button class="btn btn-primary" onclick="jumpToPage()">跳转</button>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    &copy; 2025 BCMOJ. Released under the
    <a href="https://opensource.org/licenses/MIT" target="_blank">MIT License</a>.
    | <a href="/about">关于我们</a>
    | v{{ version }}
    {% if usergroup == 'admin' %}
    | <a href="javascript:void(0);" id="checkUpdateBtn">检查更新</a>
    {% endif %}
</div>

{% if user_id not in ['None', ''] %}
<div class="action-buttons">
    {% if usergroup in ['admin', 'teacher'] %}
        <a href="/admin_results" class="btn btn-primary action-btn"><i class="bi bi-list-check"></i> 所有评测记录</a>
    {% else %}
        <a href="{{ url_for('results', userid=user_id) }}" class="btn btn-primary action-btn"><i class="bi bi-list-check"></i> 评测记录</a>
    {% endif %}

    {% if usergroup == 'admin' %}
        <a href="{{ url_for('admin_page') }}" class="btn btn-success action-btn"><i class="bi bi-gear"></i> 管理员控制台</a>
        <a href="{{ url_for('teacher_page') }}" class="btn btn-info action-btn"><i class="bi bi-journal-check"></i> 题目管理</a>
    {% elif usergroup == 'teacher' %}
        <a href="{{ url_for('teacher_page') }}" class="btn btn-info action-btn"><i class="bi bi-journal-check"></i> 题目管理</a>
    {% endif %}
</div>
{% endif %}

<script src="/static/js/popper.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>
<script>
const username = "{{ username|default('') }}";
const userId = "{{ user_id|default('') }}";
const usergroup = "{{ usergroup|default('') }}";
const totalPages = "{{ total_pages }}";
const query = "{{ query|default('') }}";

function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.id = toastId;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', function () {
        toastEl.remove();
    });
}

function initUserInfo(username, userId, usergroup) {
    const userInfo = document.getElementById('userInfo');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const editBtn = document.getElementById('editAccountBtn');

    if (username && userId && userId !== 'None') {
        let badgeColor = 'secondary';
        if (usergroup === 'admin') badgeColor = 'danger';
        else if (usergroup === 'teacher') badgeColor = 'info';
        else if (usergroup === 'student') badgeColor = 'success';

        userInfo.innerHTML = `
            <i class="bi bi-person-circle"></i>
            <span>${username} [${userId}]</span>
            <span class="badge bg-${badgeColor} ms-1">${usergroup}</span>
        `;
        loginBtn.classList.add('d-none');
        logoutBtn.classList.remove('d-none');
        editBtn.classList.remove('d-none');
    } else {
        userInfo.innerHTML = `<i class="bi bi-person-circle"></i><span>未登录</span>`;
        loginBtn.classList.remove('d-none');
        logoutBtn.classList.add('d-none');
        editBtn.classList.add('d-none');
    }
}

function initSearchInput() {
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('focus', function() {
            this.parentElement.classList.add('shadow');
        });
        searchInput.addEventListener('blur', function() {
            this.parentElement.classList.remove('shadow');
        });
    }
}

function jumpToPage() {
    const pageInput = document.getElementById('jumpPage');
    const pageNum = parseInt(pageInput.value);

    if (isNaN(pageNum) || pageNum < 1 || pageNum > parseInt(totalPages)) {
        showToast('请输入有效的页码', 'danger');
        return;
    }
    window.location.href = `{{ url_for('problems') }}?q=${encodeURIComponent(query)}&page=${pageNum}`;
}

document.addEventListener('DOMContentLoaded', function() {
    initUserInfo(username, userId, usergroup);
    initSearchInput();

    document.getElementById('loginBtn').addEventListener('click', function() {
        showToast('正在跳转...', 'info');
        window.location.href = '/login';
    });

    document.getElementById('logoutBtn').addEventListener('click', function() {
        showToast('您已成功登出', 'success');
        window.location.href = '/logout';
    });

    document.getElementById('editAccountBtn').addEventListener('click', function() {
        window.location.href = '/edit_account';
    });

{% if usergroup == 'admin' %}
    function initCheckUpdate() {
        document.getElementById('checkUpdateBtn').addEventListener('click', function() {
            showToast('正在检查更新...', 'info');
            fetch('/check_update')
                .then(response => { if (!response.ok) throw new Error('网络响应不正常'); return response.json(); })
                .then(data => {
                    if (data.error) showToast(data.error, 'danger');
                    else {
                        showToast(data.message, 'success');
                        if (data.latest && data.latest !== "{{ version }}") {
                            window.open('https://github.com/SleepingCui/BCMOJ/releases/latest', '_blank');
                        }
                    }
                })
                .catch(error => {
                    showToast('检查更新失败: ' + error.message, 'danger');
                    console.error('检查更新错误:', error);
                });
        });
    }
    initCheckUpdate();
{% endif %}
});
</script>
</body>
</html>
